# Teeracle Demo Setup
#
# The demo is parameterized with the interval that the teeracle uses to query its sources.
# Set the `TEERACLE_INTERVAL_SECONDS` variable when invoking, e.g. `TEERACLE_INTERVAL_SECONDS=4 docker compose -f docker-compose.yml -f demo-teeracle.yml up --exit-code-from demo-teeracle`
# This setup requires an API key for CoinMarketCap
# Add the API key to the environment variable `COINMARKETCAP_KEY`, with `export COINMARKETCAP_KEY=<your_key>`
services:
  integritee-teeracle-worker:
    image: ${WORKER_IMAGE_TAG:-integritee-cli:dev}
    container_name: integritee-teeracle-worker-${NETWORK:-default}
    devices:
      - "/dev/sgx/provision:/dev/sgx/provision"
      - "/dev/sgx/enclave:/dev/sgx/enclave"
    volumes:
      - "/var/run/aesmd:/var/run/aesmd"
    build:
      context: ..
      dockerfile: build.Dockerfile
      target: deployed-worker
    depends_on:
      integritee-node:
        condition: service_healthy
    environment:
      - RUST_LOG=warn,ws=warn,sp_io=warn,substrate_api_client=warn,jsonrpsee_ws_client=warn,jsonrpsee_ws_server=warn,enclave_runtime=warn,integritee_service=info,integritee_service::teeracle=debug,ita_stf=warn,ita_exchange_oracle=debug
      - COINMARKETCAP_KEY
    networks:
      - integritee-test-network-${NETWORK:-default}
    healthcheck:
      test: curl -s -f http://integritee-teeracle-worker-${NETWORK:-default}:4645/is_initialized || exit 1
      interval: 10s
      timeout: 10s
      retries: 25
    entrypoint:
        "/usr/local/bin/integritee-service --clean-reset --ws-external -M integritee-teeracle-worker-${NETWORK:-default} -T wss://integritee-teeracle-worker-${NETWORK:-default}
        -u ws://integritee-node-${NETWORK:-default} -U ws://integritee-teeracle-worker-${NETWORK:-default} -P 2011 -w 2101 -p 9912 -h 4645
        run --dev --skip-ra --teeracle-interval ${TEERACLE_INTERVAL_SECONDS}s"
    restart: always
  demo-teeracle:
    image: ${CLIENT_IMAGE_TAG:-integritee-cli:dev}
    container_name: integritee-teeracle-demo-${NETWORK:-default}
    devices:
      - "/dev/sgx/provision:/dev/sgx/provision"
      - "/dev/sgx/enclave:/dev/sgx/enclave"
    volumes:
      - "/var/run/aesmd:/var/run/aesmd"
    build:
      context: ..
      dockerfile: build.Dockerfile
      target: deployed-client
    depends_on:
      integritee-node-${NETWORK:-default}:
        condition: service_healthy
      integritee-teeracle-worker-${NETWORK:-default}:
        condition: service_healthy
    environment:
      - RUST_LOG=warn,sp_io=warn,integritee_cli::exchange_oracle=debug
    networks:
      - integritee-test-network-${NETWORK:-default}
    entrypoint:
      "/usr/local/worker-cli/demo_teeracle_whitelist.sh
      -u ws://integritee-node-${NETWORK:-default} -p 9912
      -V wss://integritee-teeracle-worker-${NETWORK:-default} -P 2011
      -d 21 -i ${TEERACLE_INTERVAL_SECONDS}
      -C /usr/local/bin/integritee-cli 2>&1"
    restart: "no"